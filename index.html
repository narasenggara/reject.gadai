<!DOCTYPE html><html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Laporan Barang Otomatis (Invoice OCR)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-5xl mx-auto p-6 space-y-6">
    <h1 class="text-2xl font-bold">Upload Invoice → OCR → Laporan</h1>
    <section class="bg-white rounded-xl shadow p-5 space-y-4">
      <input id="fileInput" type="file" accept="image/*,application/pdf" class="border p-2" />
      <button id="processBtn" class="px-4 py-2 bg-blue-600 text-white rounded">Proses OCR</button>
      <div id="progress" class="hidden text-sm text-gray-600">Memproses…</div>
      <canvas id="previewCanvas" class="w-full border"></canvas>
      <form id="ocrForm" class="space-y-3">
        <div>
          <label>Alasan</label>
          <input id="alasan" class="w-full border p-2" />
        </div>
        <div>
          <label>Barang</label>
          <input id="barang" class="w-full border p-2" />
        </div>
        <div>
          <label>Jam</label>
          <input id="jam" class="w-full border p-2" />
        </div>
        <div>
          <label>Keterangan</label>
          <input id="ket" class="w-full border p-2" />
        </div>
        <div>
          <label>Nama</label>
          <input id="nama" class="w-full border p-2" placeholder="Isi manual" />
        </div>
        <button id="saveBtn" type="button" class="px-4 py-2 bg-green-600 text-white rounded">Simpan</button>
      </form>
    </section><section class="bg-white rounded-xl shadow p-5 space-y-4">
  <h2 class="text-xl font-semibold">Laporan</h2>
  <table class="w-full text-sm border">
    <thead class="bg-gray-100">
      <tr>
        <th class="border px-2 py-1">Tanggal</th>
        <th class="border px-2 py-1">Alasan</th>
        <th class="border px-2 py-1">Barang</th>
        <th class="border px-2 py-1">Jam</th>
        <th class="border px-2 py-1">Keterangan</th>
        <th class="border px-2 py-1">Nama</th>
        <th class="border px-2 py-1">Aksi</th>
      </tr>
    </thead>
    <tbody id="reportBody"></tbody>
  </table>
</section>

  </div><script>
const DB_KEY = 'laporanInvoiceV2';
function loadDB(){ try{return JSON.parse(localStorage.getItem(DB_KEY)||'[]')}catch{return []}}
function saveDB(d){localStorage.setItem(DB_KEY,JSON.stringify(d))}

const fileInput=document.getElementById('fileInput');
const processBtn=document.getElementById('processBtn');
const progressEl=document.getElementById('progress');
const canvas=document.getElementById('previewCanvas');
const ctx=canvas.getContext('2d');
const alasanEl=document.getElementById('alasan');
const barangEl=document.getElementById('barang');
const jamEl=document.getElementById('jam');
const ketEl=document.getElementById('ket');
const namaEl=document.getElementById('nama');
const saveBtn=document.getElementById('saveBtn');
const reportBody=document.getElementById('reportBody');

let loadedFile=null;

async function renderPreview(file){
  if(file.type==='application/pdf'){
    const arrayBuf=await file.arrayBuffer();
    const pdf=await pdfjsLib.getDocument({data:arrayBuf}).promise;
    const page=await pdf.getPage(1);
    const viewport=page.getViewport({scale:1.5});
    canvas.width=viewport.width;canvas.height=viewport.height;
    await page.render({canvasContext:ctx,viewport}).promise;
  } else {
    const url=URL.createObjectURL(file);
    const img=new Image();
    await new Promise((res,rej)=>{img.onload=res;img.onerror=rej;img.src=url});
    const scale=Math.min(1,1000/img.width);
    canvas.width=img.width*scale;canvas.height=img.height*scale;
    ctx.drawImage(img,0,0,canvas.width,canvas.height);
  }
}

fileInput.addEventListener('change',async e=>{
  loadedFile=e.target.files?.[0]||null;
  if(loadedFile) await renderPreview(loadedFile);
});

processBtn.addEventListener('click',async()=>{
  if(!loadedFile){alert('Pilih file dulu');return;}
  progressEl.classList.remove('hidden');
  try{
    const dataURL=canvas.toDataURL('image/png');
    const result=await Tesseract.recognize(dataURL,'eng',{logger:m=>{if(m.status==='recognizing text'){progressEl.textContent=`OCR ${(m.progress*100).toFixed(0)}%`}}});
    const text=result.data.text||'';
    fillForm(text);
  }catch(err){alert('Gagal OCR');}
  progressEl.classList.add('hidden');
});

function fillForm(text){
  const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  function getAfter(label){
    const idx=lines.findIndex(l=>l.toLowerCase()===label.toLowerCase());
    if(idx>=0 && lines[idx+1]) return lines[idx+1];
    return '';
  }
  alasanEl.value=getAfter('Alasan');
  ketEl.value=getAfter('Keterangan');
  barangEl.value=getAfter('Barang');
  if(!jamEl.value) jamEl.value=new Date().toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'});
}

saveBtn.addEventListener('click',()=>{
  const row={
    id:crypto.randomUUID(),
    tanggal:new Date().toLocaleDateString('id-ID'),
    alasan:alasanEl.value.trim(),
    barang:barangEl.value.trim(),
    jam:jamEl.value.trim(),
    ket:ketEl.value.trim(),
    nama:namaEl.value.trim()
  };
  if(!row.barang||!row.jam){alert('Barang & Jam wajib diisi');return;}
  const db=loadDB();db.push(row);saveDB(db);renderTable();
});

function renderTable(){
  const db=loadDB();
  reportBody.innerHTML='';
  db.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class='border px-2 py-1'>${r.tanggal}</td>
      <td class='border px-2 py-1'>${r.alasan}</td>
      <td class='border px-2 py-1'>${r.barang}</td>
      <td class='border px-2 py-1'>${r.jam}</td>
      <td class='border px-2 py-1'>${r.ket}</td>
      <td class='border px-2 py-1'>${r.nama}</td>
      <td class='border px-2 py-1'><button onclick='shareWA("${r.id}")' class='text-blue-600 underline'>Share WA</button></td>`;
    reportBody.appendChild(tr);
  });
}

function shareWA(id){
  const db=loadDB();
  const r=db.find(x=>x.id===id);
  if(!r) return;
  const text=`Laporan Barang Masuk%0AAlasan: ${encodeURIComponent(r.alasan)}%0ABarang: ${encodeURIComponent(r.barang)}%0AJam: ${encodeURIComponent(r.jam)}%0AKeterangan: ${encodeURIComponent(r.ket)}%0ANama: ${encodeURIComponent(r.nama)}%0ATanggal: ${encodeURIComponent(r.tanggal)}`;
  window.open(`https://wa.me/?text=${text}`,'_blank');
}

renderTable();
</script></body>
</html>
